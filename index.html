<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOCKET å·¥ç¨‹ä½¿ç”¨ç´€éŒ„</title>
    <!-- è¼‰å…¥å¿…è¦é–‹ç™¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        /* æ¨™é¡Œåˆ—æ·±è‰²é€æ˜èƒŒæ™¯ */
        .glass-header {
            background-color: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        #reader__scan_region video { border-radius: 1.5rem !important; object-fit: cover !important; }
        button:active { transform: scale(0.95); transition: transform 0.1s; }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-toast { animation: fade-in-up 0.3s ease-out forwards; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBgUa7rlHF3pjyH3Wrmtu4KqOF5FoKdJVQ",
            authDomain: "socket-management-21bf2.firebaseapp.com",
            projectId: "socket-management-21bf2",
            storageBucket: "socket-management-21bf2.firebasestorage.app",
            messagingSenderId: "659489977140",
            appId: "1:659489977140:web:b411e7ae52c5078ef46b61",
            measurementId: "G-E97BVY2WB8"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "socket-management-21bf2";

        const App = () => {
            const [user, setUser] = useState(null);
            const [isPageLocked, setIsPageLocked] = useState(true); 
            const [entryPassword, setEntryPassword] = useState('');
            const [activeTab, setActiveTab] = useState('checkout');
            const [records, setRecords] = useState([]);
            const [loading, setLoading] = useState(true);

            // UI èˆ‡ ç¯©é¸ç‹€æ…‹
            const [showScanner, setShowScanner] = useState(false);
            const [scannerTarget, setScannerTarget] = useState('checkout'); 
            const [historySearchTerm, setHistorySearchTerm] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [showOnlyOverdue, setShowOnlyOverdue] = useState(false);

            const [showOverdueModal, setShowOverdueModal] = useState(false);
            const [showReturnModal, setShowReturnModal] = useState(false);
            const [returnSearchQuery, setReturnSearchQuery] = useState(''); 
            const [selectedItemsToReturn, setSelectedItemsToReturn] = useState([]); 

            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [deletePassword, setDeletePassword] = useState('');
            const [pendingDeleteIds, setPendingDeleteIds] = useState([]);
            const [passwordError, setPasswordError] = useState(false);
            const [toastMsg, setToastMsg] = useState('');

            // è¼¸å…¥è¡¨å–®
            const [formData, setFormData] = useState({ user: '', itemInput: '' });
            const [tempItems, setTempItems] = useState([]);
            const [inputError, setInputError] = useState(''); 
            
            const html5QrCodeRef = useRef(null);

            // èªè­‰åˆå§‹åŒ–
            useEffect(() => {
                auth.signInAnonymously().catch(err => console.error("èªè­‰å¤±æ•—", err));
                const unsubscribe = auth.onAuthStateChanged((u) => setUser(u));
                return () => unsubscribe();
            }, []);

            // ç›£è½ Firestore è³‡æ–™
            useEffect(() => {
                if (!user) return;
                const recordsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records');
                const unsubscribe = recordsRef.onSnapshot((snapshot) => {
                    const dbData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // æ’é™¤æ¸¬è©¦é—œéµå­—è³‡æ–™
                    const formalData = dbData.filter(r => !['æ¸¬è©¦', 'ç„¡æ­¤äºº', 'ç¯„ä¾‹'].some(name => r.user?.includes(name)));
                    setRecords(formalData.sort((a, b) => new Date(b.date) - new Date(a.date)));
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            // åœ–ç¤ºèˆ‡çµ„ä»¶æ›´æ–°æ™‚è§¸ç™¼
            useEffect(() => {
                setTimeout(() => { if(window.lucide) window.lucide.createIcons(); }, 200);
            }, [activeTab, showScanner, records, isPageLocked, toastMsg, showOverdueModal, showOnlyOverdue, isDeleteModalOpen, showReturnModal]);

            // é€¾æœŸåˆ¤å®š (3å¤©)
            const isOverdue = (dateString) => Math.ceil(Math.abs(new Date() - new Date(dateString)) / (1000 * 60 * 60 * 24)) > 3;
            
            const activeRecords = useMemo(() => records.filter(r => r.status === 'Checked Out'), [records]);
            const overdueCount = activeRecords.filter(r => isOverdue(r.date)).length;

            const displayedActiveRecords = useMemo(() => {
                return showOnlyOverdue ? activeRecords.filter(r => isOverdue(r.date)) : activeRecords;
            }, [activeRecords, showOnlyOverdue]);

            const filteredHistoryRecords = useMemo(() => {
                return records.filter(r => {
                    const term = historySearchTerm.toLowerCase();
                    const matchesSearch = r.user?.toLowerCase().includes(term) || r.items?.some(i => i.toLowerCase().includes(term));
                    const recordDate = new Date(r.date);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    if (end) end.setHours(23, 59, 59, 999);
                    const matchesDate = (!start || recordDate >= start) && (!end || recordDate <= end);
                    return matchesSearch && matchesDate;
                });
            }, [records, historySearchTerm, startDate, endDate]);

            const groupedHistory = useMemo(() => {
                const groups = {};
                filteredHistoryRecords.forEach(rec => {
                    const dateKey = new Date(rec.returnDate || rec.date).toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
                    if (!groups[dateKey]) groups[dateKey] = [];
                    groups[dateKey].push(rec);
                });
                return Object.keys(groups).sort((a, b) => new Date(b) - new Date(a)).map(date => ({
                    date, data: groups[date].sort((a, b) => a.status === 'Checked Out' ? -1 : 1)
                }));
            }, [filteredHistoryRecords]);

            const showToast = (msg) => {
                setToastMsg(msg);
                setTimeout(() => setToastMsg(''), 2500);
            };

            const handleEntry = () => {
                // å…¥å£å¯†ç¢¼ï¼š620026
                if (entryPassword === '620026') {
                    setIsPageLocked(false);
                } else {
                    setPasswordError(true);
                    setTimeout(() => setPasswordError(false), 1000);
                }
            };

            const addSocketToTemp = (code) => {
                const socketId = code.trim().toUpperCase();
                if (!socketId) return;
                if (tempItems.includes(socketId)) {
                    setInputError(`ç·¨è™Ÿ ${socketId} å·²åœ¨æœ¬æ¬¡æ¸…å–®ä¸­`);
                    setTimeout(() => setInputError(''), 3000);
                    return;
                }
                const owner = activeRecords.find(r => r.items.includes(socketId));
                if (owner) {
                    setInputError(`ç·¨è™Ÿ ${socketId} æ­£è¢« ${owner.user} é ˜ç”¨`);
                    setTimeout(() => setInputError(''), 4000);
                    return;
                }
                setTempItems(prev => [socketId, ...prev]); 
                setFormData(prev => ({ ...prev, itemInput: '' }));
                setInputError('');
            };

            const handleCheckoutClick = () => {
                if (tempItems.length === 0 || !formData.user) return;
                const userOverdue = records.filter(r => r.user.trim() === formData.user.trim() && r.status === 'Checked Out' && isOverdue(r.date));
                if (userOverdue.length > 0) { setShowOverdueModal(true); return; }
                executeCheckout();
            };

            const executeCheckout = async () => {
                setShowOverdueModal(false);
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records').add({
                        user: formData.user, items: [...tempItems], date: new Date().toISOString(), status: 'Checked Out', createdAt: Date.now()
                    });
                    setFormData({ user: '', itemInput: '' });
                    setTempItems([]);
                    setActiveTab('in_use');
                    showToast('é ˜ç”¨ç™»è¨˜å®Œæˆ');
                } catch (err) { console.error(err); }
            };

            const executeReturn = async () => {
                const groups = {};
                selectedItemsToReturn.forEach(key => {
                    const [rid, val] = key.split('|');
                    if (!groups[rid]) groups[rid] = [];
                    groups[rid].push(val);
                });
                try {
                    for (const rid in groups) {
                        const selected = groups[rid];
                        const original = records.find(r => r.id === rid);
                        const remaining = original.items.filter(i => !selected.includes(i));
                        const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records').doc(rid);
                        if (remaining.length === 0) {
                            await docRef.update({ status: 'Returned', returnDate: new Date().toISOString() });
                        } else {
                            await docRef.update({ items: remaining });
                            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records').add({
                                user: original.user, items: selected, date: original.date, status: 'Returned', returnDate: new Date().toISOString(), createdAt: Date.now()
                            });
                        }
                    }
                    setShowReturnModal(false);
                    setSelectedItemsToReturn([]);
                    setReturnSearchQuery('');
                    setActiveTab('history');
                    showToast('è¨˜å¾—æ”¾åœ¨æ­¸é‚„ç®±å–”ï¼Œæ„Ÿè¬é…åˆï¼');
                } catch (err) { console.error(err); }
            };

            const startScanner = (target) => {
                setShowScanner(true);
                setScannerTarget(target);
                setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCodeRef.current = html5QrCode;
                    html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: { width: 250, height: 250 } },
                        (text) => {
                            if (target === 'checkout') addSocketToTemp(text);
                            else setReturnSearchQuery(text.trim().toUpperCase());
                            stopScanner();
                        },
                        () => {}
                    ).catch(() => setShowScanner(false));
                }, 300);
            };

            const stopScanner = () => {
                if (html5QrCodeRef.current) {
                    html5QrCodeRef.current.stop().then(() => { html5QrCodeRef.current.clear(); setShowScanner(false); }).catch(() => setShowScanner(false));
                } else { setShowScanner(false); }
            };

            const exportCSV = () => {
                if (filteredHistoryRecords.length === 0) return;
                const headers = ["æ—¥æœŸ", "äººå“¡", "Socket", "ç‹€æ…‹"];
                let csv = "\uFEFF" + headers.join(",") + "\n";
                filteredHistoryRecords.forEach(r => csv += `"${new Date(r.date).toLocaleString()}","${r.user}","${r.items.join(';')}","${r.status === 'Checked Out' ? 'é ˜ç”¨ä¸­' : 'å·²æ­¸é‚„'}"\n`);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `SOCKET_ç´€éŒ„_${new Date().toLocaleDateString()}.csv`;
                link.click();
                showToast('æ­·å²ç´€éŒ„å·²åŒ¯å‡º');
            };

            // å…¥å£é–ç•«é¢ (å¯†ç¢¼: 620026)
            if (isPageLocked) {
                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-8 text-center">
                        <div className="bg-white/10 w-24 h-24 rounded-3xl flex items-center justify-center mb-8 backdrop-blur-xl border border-white/20">
                            <i data-lucide="lock" className="w-14 h-14 text-white"></i>
                        </div>
                        <h1 className="text-white text-3xl font-black mb-4 tracking-tight uppercase">SOCKET ç®¡ç†ç³»çµ±</h1>
                        <p className="text-slate-400 text-base mb-10">è«‹è¼¸å…¥é€šè¡Œå¯†ç¢¼ä»¥é€²å…¥</p>
                        <div className="w-full max-w-xs space-y-4">
                            <input 
                                type="text" inputMode="numeric" pattern="[0-9]*"
                                className={`w-full bg-white/5 border-2 rounded-2xl py-6 text-center text-4xl font-black tracking-widest text-white outline-none transition-all ${passwordError ? 'border-rose-500 animate-shake' : 'border-white/10 focus:border-blue-500'}`} 
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"
                                value={entryPassword}
                                onChange={(e) => { setEntryPassword(e.target.value); setPasswordError(false); }}
                                onKeyPress={(e) => e.key === 'Enter' && handleEntry()}
                            />
                            <button onClick={handleEntry} className="w-full py-5 bg-blue-600 text-white rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-all">é€²å…¥ç³»çµ±</button>
                        </div>
                        <div className="mt-12 text-xs text-slate-500 font-bold uppercase tracking-widest">Engineering Dept Only</div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col max-w-md mx-auto shadow-2xl pb-24 font-sans relative overflow-x-hidden border-x border-slate-200">
                    
                    {toastMsg && (
                        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[200] bg-slate-800/95 backdrop-blur-sm text-white px-8 py-5 rounded-[2rem] text-base font-black shadow-2xl animate-toast flex items-center justify-center gap-3 min-w-[300px]">
                            <i data-lucide="check-circle-2" className="w-6 h-6 text-green-400"></i>
                            <span>{toastMsg}</span>
                        </div>
                    )}

                    {/* Modalï¼šæ­¸é‚„ç¢ºèª (å„ªåŒ–å°ºå¯¸èˆ‡ç½®ä¸­) */}
                    {showReturnModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
                            <div className="bg-white rounded-[2rem] p-6 w-full max-w-[300px] shadow-2xl text-center space-y-4">
                                <div className="text-emerald-600 flex justify-center"><i data-lucide="inbox" className="w-12 h-12"></i></div>
                                <div className="space-y-2">
                                    <h3 className="text-xl font-black text-slate-800">æ­¸é‚„ç¢ºèª</h3>
                                    <p className="text-sm font-bold text-emerald-700 leading-relaxed px-2 bg-emerald-50 py-3 rounded-2xl">è¨˜å¾—æ”¾åœ¨æ­¸é‚„ç®±å–”ï¼<br/>æ„Ÿè¬æ‚¨çš„é…åˆã€‚</p>
                                </div>
                                <div className="flex flex-col gap-2">
                                    <button onClick={executeReturn} className="w-full py-4 bg-emerald-600 text-white rounded-2xl font-black shadow-lg text-lg">ç¢ºèªï¼Œå·²æ­¸é‚„</button>
                                    <button onClick={() => setShowReturnModal(false)} className="text-slate-400 font-bold text-sm py-1">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modalï¼šç®¡ç†é©—è­‰ (å„ªåŒ–å°ºå¯¸èˆ‡ç½®ä¸­) */}
                    {isDeleteModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-md">
                            <div className="bg-white rounded-[1.8rem] p-6 w-full max-w-[280px] shadow-2xl space-y-5 text-center">
                                <h3 className="text-xl font-black text-slate-800">ç®¡ç†å“¡é©—è­‰</h3>
                                <input 
                                    type="text" inputMode="numeric" pattern="[0-9]*" 
                                    className={`w-full bg-slate-50 border-2 rounded-2xl px-4 py-4 text-center text-3xl font-black tracking-widest outline-none ${passwordError ? 'border-rose-500 bg-rose-50' : 'border-slate-200 focus:border-blue-600'}`} 
                                    placeholder="å¯†ç¢¼" value={deletePassword} 
                                    onChange={(e) => {setDeletePassword(e.target.value); setPasswordError(false);}} 
                                />
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => {setIsDeleteModalOpen(false); setDeletePassword('');}} className="py-3 bg-slate-100 text-slate-500 rounded-2xl font-black">å–æ¶ˆ</button>
                                    <button onClick={async () => {
                                        if(deletePassword === '168168') {
                                            for(const id of pendingDeleteIds) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('records').doc(id).delete();
                                            setIsDeleteModalOpen(false); setDeletePassword(''); showToast('ç´€éŒ„å·²åˆªé™¤');
                                        } else setPasswordError(true);
                                    }} className="py-3 bg-rose-600 text-white rounded-2xl font-black shadow-lg">ç¢ºèª</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modalï¼šé€¾æœŸæº«é¦¨æé†’ (å„ªåŒ–å°ºå¯¸èˆ‡ç½®ä¸­) */}
                    {showOverdueModal && (
                        <div className="fixed inset-0 z-[160] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
                            <div className="bg-white rounded-[2rem] p-6 w-full max-w-[300px] shadow-2xl text-center space-y-4">
                                <div className="text-rose-500 flex justify-center">
                                    <div className="relative"><i data-lucide="home" className="w-14 h-14 opacity-10"></i><i data-lucide="heart" className="w-9 h-9 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-rose-500 fill-rose-500"></i></div>
                                </div>
                                <div className="space-y-2">
                                    <h3 className="text-xl font-black text-slate-800">æº«é¦¨æé†’</h3>
                                    <p className="text-sm font-bold text-slate-600 leading-relaxed px-1">å—¨ {formData.user}ï¼Œæ‚¨çš„ Socket æµæµªå¤ªä¹…äº†ï¼Œ<br/><span className="text-rose-600 font-black underline decoration-2">è¨˜å¾—å¸¶å®ƒå›å®¶ï¼ˆæ­¸é‚„ï¼‰</span>å–”ï¼</p>
                                </div>
                                <div className="flex flex-col gap-2">
                                    <button onClick={() => { setShowOverdueModal(false); setActiveTab('return'); setReturnSearchQuery(formData.user); }} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black shadow-lg text-lg">å¥½ï¼Œå…ˆå»æ­¸é‚„</button>
                                    <button onClick={executeCheckout} className="text-slate-400 font-bold text-xs underline decoration-dotted py-1">ä»è¦é ˜ç”¨</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showScanner && (
                        <div className="fixed inset-0 z-[150] bg-black flex flex-col items-center justify-center p-6">
                            <div className="w-full max-w-sm relative text-center">
                                <button onClick={stopScanner} className="absolute -top-16 right-0 text-white p-4 bg-white/10 rounded-full"><i data-lucide="x" className="w-9 h-9"></i></button>
                                <div id="reader" className="w-full rounded-3xl overflow-hidden border-4 border-blue-500 shadow-2xl bg-slate-900"></div>
                            </div>
                        </div>
                    )}

                    <header className="glass-header text-white p-6 sticky top-0 z-20 shadow-xl flex justify-between items-center border-b border-white/10">
                        <h1 className="text-xl font-black tracking-tight uppercase tracking-wider">SOCKET å·¥ç¨‹ä½¿ç”¨ç´€éŒ„</h1>
                        <div className="flex flex-col items-end">
                            <div className="text-[11px] font-black text-slate-300 flex items-center gap-1.5 uppercase bg-white/10 px-3 py-1.5 rounded-full">
                                <div className={`w-2 h-2 rounded-full ${user ? 'bg-green-500 shadow-[0_0_8px_#22c55e]' : 'bg-amber-500'}`} /> {user ? 'Online' : 'Sync'}
                            </div>
                            <span className="text-[10px] font-bold text-rose-400 mt-1 mr-1">å€Ÿå‡ºé€¾3å¤©è¦–ç‚ºé€¾æœŸ</span>
                        </div>
                    </header>

                    <nav className="flex bg-white border-b sticky top-[84px] z-10 shadow-sm">
                        {[{ id: 'checkout', label: 'é ˜å‡º', icon: 'log-out' }, { id: 'return', label: 'æ­¸é‚„', icon: 'log-in' }, { id: 'in_use', label: 'ä½¿ç”¨ä¸­', icon: 'clock' }, { id: 'history', label: 'æ­·å²', icon: 'history' }].map((tab) => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 py-4 text-sm font-black transition-all flex flex-col items-center relative ${activeTab === tab.id ? 'text-blue-700 bg-blue-50/50' : 'text-slate-400'}`}>
                                <i data-lucide={tab.icon} className="w-6 h-6 mb-1"></i> {tab.label}
                                {activeTab === tab.id && <div className="absolute bottom-0 left-0 right-0 h-1.5 bg-blue-700 rounded-t-full" />}
                            </button>
                        ))}
                    </nav>

                    <main className="p-4 flex-1 overflow-y-auto no-scrollbar">
                        {activeTab === 'checkout' && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <div className="bg-white p-5 sm:p-7 rounded-[2.5rem] shadow-sm border border-slate-200">
                                    <label className="text-slate-400 font-black text-xs uppercase mb-3 block tracking-widest text-center">é ˜ç”¨äººå§“å</label>
                                    <input type="text" className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-5 text-xl font-bold outline-none focus:border-blue-600 mb-8 transition-all" placeholder="è¼¸å…¥å§“å" value={formData.user} onChange={(e) => setFormData({...formData, user: e.target.value})} />
                                    
                                    <div className="flex justify-between items-center mb-4 px-1">
                                        <label className="text-slate-400 font-black text-xs uppercase tracking-widest">é ˜ç”¨ç·¨è™Ÿè¼¸å…¥</label>
                                        <button onClick={() => startScanner('checkout')} className="px-6 py-2.5 bg-blue-600 text-white rounded-xl shadow-lg text-sm font-black flex items-center gap-1.5 active:scale-95 transition-all"><i data-lucide="qr-code" className="w-5 h-5"></i> æƒæ</button>
                                    </div>
                                    <div className="h-7 mb-1">{inputError && <p className="text-rose-500 text-xs font-black flex items-center gap-1.5 animate-pulse"><i data-lucide="alert-triangle" className="w-4 h-4"></i> {inputError}</p>}</div>
                                    
                                    <div className="flex items-center gap-3 mb-8 px-1 overflow-hidden">
                                        <input 
                                            type="text" 
                                            className={`flex-1 min-w-0 bg-slate-50 border-2 rounded-2xl px-5 py-4 text-base font-bold outline-none transition-all uppercase ${inputError ? 'border-rose-500 bg-rose-50' : 'border-slate-100 focus:border-blue-600'}`} 
                                            placeholder="æ‰‹å‹•è¼¸å…¥" 
                                            value={formData.itemInput} 
                                            onChange={(e) => {setFormData({...formData, itemInput: e.target.value.toUpperCase()}); setInputError('');}} 
                                            onKeyPress={(e) => e.key === 'Enter' && addSocketToTemp(formData.itemInput)} 
                                        />
                                        <button onClick={() => addSocketToTemp(formData.itemInput)} className="w-14 h-14 bg-slate-900 text-white rounded-2xl flex-none flex items-center justify-center font-bold text-3xl shadow-md active:scale-90">+</button>
                                    </div>

                                    <label className="text-slate-400 font-black text-xs uppercase tracking-widest mb-4 block text-center">å¾…ç™»è¨˜æ¸…å–®</label>
                                    <div className="space-y-3 mb-8 min-h-[120px] max-h-[350px] overflow-y-auto no-scrollbar border-y border-slate-50 py-3">
                                        {tempItems.map((item, i) => (
                                            <div key={i} className="flex justify-between items-center bg-blue-50/50 px-5 py-4 rounded-2xl border border-blue-100 animate-in zoom-in-95">
                                                <span className="font-mono font-black text-blue-900 text-lg uppercase">{item}</span>
                                                <button onClick={() => setTempItems(tempItems.filter((_, idx) => idx !== i))} className="text-rose-400 p-2 active:scale-90"><i data-lucide="trash-2" className="w-6 h-6"></i></button>
                                            </div>
                                        ))}
                                        {tempItems.length === 0 && <div className="py-12 text-center text-slate-300 font-black italic border-2 border-dashed border-slate-100 rounded-2xl text-sm">ç›®å‰æ¸…å–®ç‚ºç©º</div>}
                                    </div>
                                    <button disabled={tempItems.length === 0 || !formData.user} onClick={handleCheckoutClick} className="w-full py-6 bg-blue-600 text-white rounded-[2rem] font-black text-xl shadow-xl active:scale-[0.98] disabled:bg-slate-100 disabled:text-slate-300 flex items-center justify-center gap-3 transition-all"><i data-lucide="check-circle-2" className="w-7 h-7"></i> ç¢ºèªç™»è¨˜é ˜å‡º</button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'return' && (
                            <div className="space-y-4 animate-in fade-in duration-300 pb-10">
                                <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border-t-8 border-emerald-500 border border-slate-200">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-2xl font-black text-emerald-800">æ­¸é‚„ä¸­å¿ƒ</h3>
                                        <div className="flex gap-2">
                                            <button onClick={() => startScanner('return')} className="p-3.5 bg-slate-900 text-white rounded-xl shadow-lg active:scale-95 flex items-center justify-center"><i data-lucide="qr-code" className="w-5 h-5"></i></button>
                                            <button disabled={selectedItemsToReturn.length === 0} onClick={() => setShowReturnModal(true)} className={`px-5 py-2.5 rounded-xl font-black text-sm shadow-lg flex items-center gap-2 transition-all active:scale-95 ${selectedItemsToReturn.length > 0 ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-300'}`}><i data-lucide="package-check" className="w-5 h-5"></i> åŸ·è¡Œæ­¸é‚„ ({selectedItemsToReturn.length})</button>
                                        </div>
                                    </div>
                                    <div className="relative mb-6">
                                        <i data-lucide="search" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 w-5 h-5" />
                                        <input type="text" className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl pl-12 pr-4 py-5 text-base font-bold outline-none focus:border-emerald-600 transition-all" placeholder="æœå°‹äººåæˆ–ç·¨è™Ÿ..." value={returnSearchQuery} onChange={(e) => setReturnSearchQuery(e.target.value)} />
                                    </div>
                                    <div className="space-y-4 min-h-[200px] no-scrollbar">
                                        {activeRecords.filter(r => (r.user.includes(returnSearchQuery) || r.items.some(i => i.includes(returnSearchQuery)))).map(rec => (
                                            <div key={rec.id} className="rounded-[2rem] border-2 p-5 border-slate-100 bg-white shadow-sm">
                                                <div className="flex justify-between items-center mb-4">
                                                    <span className="font-black text-base text-slate-800 bg-slate-100 px-4 py-1.5 rounded-xl">{rec.user}</span>
                                                    <button onClick={() => {
                                                        const keys = rec.items.map(i => `${rec.id}|${i}`);
                                                        const allSelected = keys.every(k => selectedItemsToReturn.includes(k));
                                                        if(allSelected) setSelectedItemsToReturn(prev => prev.filter(k => !keys.includes(k)));
                                                        else setSelectedItemsToReturn(prev => [...new Set([...prev, ...keys])]);
                                                    }} className="text-sm font-bold text-blue-500 underline">å…¨é¸</button>
                                                </div>
                                                <div className="grid grid-cols-1 gap-2.5">
                                                    {rec.items.map(item => {
                                                        const key = `${rec.id}|${item}`;
                                                        const sel = selectedItemsToReturn.includes(key);
                                                        return (
                                                            <div key={item} onClick={() => setSelectedItemsToReturn(sel ? selectedItemsToReturn.filter(k => k !== key) : [...selectedItemsToReturn, key])} className={`px-5 py-4 rounded-2xl border flex justify-between items-center cursor-pointer transition-all ${sel ? 'bg-emerald-50 border-emerald-300 shadow-inner' : 'bg-white border-slate-100'}`}>
                                                                <span className="font-mono text-base font-bold text-slate-600 uppercase">{item}</span>
                                                                <span>{sel ? 'âœ…' : 'â¬œ'}</span>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'in_use' && (
                            <div className="space-y-4 animate-in fade-in duration-300 pb-10">
                                <div className="flex justify-between items-center px-2 py-2">
                                    <div className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="clock" className="w-4 h-4"></i>{showOnlyOverdue ? `é€¾æœŸé …ç›® (${overdueCount})` : `å…¨éƒ¨é ˜ç”¨ (${activeRecords.length})`}</div>
                                    <button onClick={() => setShowOnlyOverdue(!showOnlyOverdue)} className={`px-5 py-2 rounded-full text-xs font-black transition-all flex items-center gap-1.5 shadow-sm ${showOnlyOverdue ? 'bg-rose-500 text-white' : 'bg-slate-200 text-slate-500'}`}>{showOnlyOverdue ? "é¡¯ç¤ºå…¨éƒ¨" : "åªçœ‹é€¾æœŸ"}</button>
                                </div>
                                {displayedActiveRecords.length === 0 ? (
                                    <div className="text-center py-20 text-slate-300 font-black italic">{showOnlyOverdue ? "ç›®å‰æ²’æœ‰é€¾æœŸé …ç›® ğŸ‰" : "ç›®å‰ç„¡é ˜ç”¨ä¸­çš„ç´€éŒ„"}</div>
                                ) : (
                                    displayedActiveRecords.map(rec => {
                                        const overdue = isOverdue(rec.date);
                                        const daysUsed = Math.floor(Math.abs(new Date() - new Date(rec.date)) / (1000 * 60 * 60 * 24));
                                        return (
                                            <div key={rec.id} className={`bg-white rounded-[2rem] p-6 border-l-[12px] shadow-sm transition-all ${overdue ? 'border-rose-600 bg-rose-50/10' : 'border-blue-600'}`}>
                                                <div className="flex justify-between items-center mb-5">
                                                    <div className="flex items-center gap-2.5">
                                                        <span className={`px-5 py-1.5 rounded-xl font-black text-base ${overdue ? 'bg-rose-100 text-rose-700' : 'bg-blue-100 text-blue-700'}`}>{rec.user}</span>
                                                        <span className={`text-[10px] font-black uppercase px-2.5 py-1 rounded-lg ${overdue ? 'bg-rose-500 text-white animate-pulse' : 'bg-blue-500 text-white'}`}>{overdue ? 'æµæµªä¸­' : 'å·¥ä½œä¸­'}</span>
                                                    </div>
                                                    {overdue && <i data-lucide="alert-triangle" className="text-rose-600 w-6 h-6"></i>}
                                                </div>
                                                <div className="flex flex-wrap gap-2.5 mb-5">{rec.items.map(i => <span key={i} className="px-4 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono font-bold text-slate-600 uppercase">{i}</span>)}</div>
                                                <div className="text-xs font-black text-slate-400 border-t border-slate-50 pt-5 flex justify-between items-center">
                                                    <div className="flex items-center gap-1.5 font-bold"><i data-lucide="calendar" className="w-4 h-4"></i>å·²é ˜ç”¨ {daysUsed} å¤©</div>
                                                    <div className="flex gap-2.5">
                                                        {overdue && <button onClick={() => {
                                                            const text = `å—¨ ${rec.user}ï¼Œæº«é¦¨æé†’æ‚¨é ˜ç”¨çš„ Socket ç·¨è™Ÿ (${rec.items.join(', ')}) å·²ç¶“åœ¨å¤–é¢æµæµªç´„ ${daysUsed} å¤©äº†ï¼Œè‹¥å·¥ç¨‹å·²çµæŸï¼Œè¨˜å¾—å¸¶å®ƒå›å®¶ï¼ˆæ­¸é‚„ï¼‰å–”ï¼è¾›è‹¦äº†ï¼Œè¬è¬ï¼`;
                                                            const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showToast('æé†’æ–‡å­—å·²è¤‡è£½');
                                                        }} className="bg-amber-100 text-amber-700 px-4 py-2 rounded-xl font-black text-xs flex items-center gap-1.5 active:bg-amber-200 border border-amber-200 shadow-sm"><i data-lucide="send" className="w-4 h-4"></i> æº«é¦¨æé†’</button>}
                                                        <button onClick={() => { setActiveTab('return'); setReturnSearchQuery(rec.user); }} className="bg-slate-900 text-white px-4 py-2 rounded-xl font-black text-xs flex items-center gap-1.5 uppercase shadow-md active:bg-slate-700 transition-all">å‰å¾€æ­¸é‚„</button>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="space-y-4 pb-20 animate-in fade-in duration-300">
                                <div className="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-200 space-y-5">
                                    <div className="relative">
                                        <i data-lucide="search" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 w-5 h-5" />
                                        <input type="text" className="w-full pl-12 pr-4 py-4 rounded-2xl border-2 border-slate-100 outline-none focus:border-blue-500 font-bold text-base shadow-inner transition-all" placeholder="æœå°‹å§“åæˆ–ç·¨è™Ÿ..." value={historySearchTerm} onChange={e => setHistorySearchTerm(e.target.value)} />
                                    </div>
                                    <div className="space-y-3">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="space-y-1.5">
                                                <label className="text-[11px] font-black text-slate-400 uppercase ml-2">é–‹å§‹æ—¥æœŸ</label>
                                                <input type="date" className="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:border-blue-500" value={startDate} onChange={e => setStartDate(e.target.value)} />
                                            </div>
                                            <div className="space-y-1.5">
                                                <label className="text-[11px] font-black text-slate-400 uppercase ml-2">çµæŸæ—¥æœŸ</label>
                                                <input type="date" className="w-full bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:border-blue-500" value={endDate} onChange={e => setEndDate(e.target.value)} />
                                            </div>
                                        </div>
                                        <button onClick={exportCSV} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-sm flex items-center justify-center gap-2.5 active:bg-slate-700 transition-all shadow-md"><i data-lucide="file-spreadsheet" className="w-5 h-5 text-green-400"></i> åŒ¯å‡ºç¯©é¸æ¸…å–® (CSV)</button>
                                    </div>
                                </div>
                                {groupedHistory.length === 0 ? (
                                    <div className="text-center py-20 text-slate-300 font-black italic">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</div>
                                ) : (
                                    groupedHistory.map(g => (
                                        <div key={g.date} className="space-y-3">
                                            <div className="text-xs font-black text-slate-400 uppercase py-2 tracking-widest pl-3 flex items-center gap-2"><i data-lucide="calendar-days" className="w-4 h-4"></i> {g.date}</div>
                                            {g.data.map(rec => (
                                                <div key={rec.id} className="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm flex flex-col group transition-all relative">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <h4 className="font-black text-base text-slate-800">{rec.user}</h4>
                                                            <p className="text-[11px] text-slate-400 mt-1.5 uppercase font-bold">{rec.status === 'Checked Out' ? 'é ˜ç”¨æ–¼' : 'æ­¸é‚„æ–¼'} {new Date(rec.returnDate || rec.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                                        </div>
                                                        <div className="flex items-center gap-2.5">
                                                            <span className={`text-[10px] font-black px-3 py-1 rounded-full ${rec.status === 'Checked Out' ? 'bg-blue-50 text-blue-600' : 'bg-emerald-50 text-emerald-600'}`}>{rec.status === 'Checked Out' ? 'é ˜ç”¨ä¸­' : 'å·²æ­¸é‚„'}</span>
                                                            <button onClick={() => { setIsDeleteModalOpen(true); setPendingDeleteIds([rec.id]); }} className="text-rose-300 p-2 active:text-rose-500 transition-all"><i data-lucide="trash-2" className="w-6 h-6"></i></button>
                                                        </div>
                                                    </div>
                                                    <div className="mt-4 flex flex-wrap gap-2">{rec.items.map(i => <span key={i} className="text-xs font-mono font-bold text-slate-500 bg-slate-50 px-3 py-1 border border-slate-100 rounded-lg uppercase">{i}</span>)}</div>
                                                </div>
                                            ))}
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </main>

                    <footer className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 border-t border-slate-200 px-8 py-5 flex justify-between items-center z-30 shadow-2xl backdrop-blur-md">
                        <div className="flex space-x-12">
                            <div className="flex flex-col"><span className="text-[11px] text-slate-400 font-black uppercase tracking-widest leading-tight">ä½¿ç”¨ä¸­</span><span className="text-2xl font-black text-blue-700 leading-none">{activeRecords.length}</span></div>
                            <div className="flex flex-col"><span className="text-[11px] text-slate-400 font-black uppercase tracking-widest leading-tight">é€¾æœŸ</span><span className={`text-2xl font-black leading-none ${overdueCount > 0 ? 'text-rose-600' : 'text-slate-200'}`}>{overdueCount}</span></div>
                        </div>
                        <div className="text-[10px] font-black text-slate-300 italic tracking-widest uppercase">Socket Final V9.1</div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>